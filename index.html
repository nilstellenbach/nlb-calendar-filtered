<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalender mit OAuth</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #authorize_button, #signout_button {
      display: inline-block;
      margin: 10px 10px 20px 0;
      padding: 8px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Kalender mit OAuth & Filter</h1>
  <button id="authorize_button">Anmelden</button>
  <button id="signout_button" style="display:none;">Abmelden</button>
  <div id="calendar"></div>

  <script>
    const CLIENT_ID = '794854831337-fkvt0gc4fjb9585e983hvge8k0dtlh83.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDd9dN4lfFEFiQA5lStG8Y4Jfy2S2Z4fPo'; // Optional, aber OAuth reicht eigentlich
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    const calendarId = '02e47bf45d2144936339173a08382e8537e484e745446dadc69a77fc4ce5f303@group.calendar.google.com';
    const unwantedKeyword = 'nati';

    let calendar;

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: [DISCOVERY_DOC],
        scope: SCOPES
      }).then(() => {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

        authorizeButton.onclick = () => gapi.auth2.getAuthInstance().signIn();
        signoutButton.onclick = () => gapi.auth2.getAuthInstance().signOut();
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'inline-block';
        listUpcomingEvents();
      } else {
        authorizeButton.style.display = 'inline-block';
        signoutButton.style.display = 'none';
        if(calendar) {
          calendar.destroy();
          calendar = null;
        }
      }
    }

    async function listUpcomingEvents() {
      const response = await gapi.client.calendar.events.list({
        calendarId: calendarId,
        timeMin: (new Date()).toISOString(),
        showDeleted: false,
        singleEvents: true,
        maxResults: 250,
        orderBy: 'startTime',
      });

      const events = response.result.items || [];

      const filteredEvents = events
        .filter(event => !event.summary?.toLowerCase().includes(unwantedKeyword))
        .map(event => ({
          title: event.summary,
          start: event.start.dateTime || event.start.date,
          end: event.end.dateTime || event.end.date,
        }));

      renderCalendar(filteredEvents);
    }

    function renderCalendar(events) {
      if(calendar) {
        calendar.destroy();
      }
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: events
      });
      calendar.render();
    }

    window.onload = () => {
      // Google API client laden
      handleClientLoad();
    }
  </script>
</body>
</html>

